---
title: "Clustering using cisTopic"
output: html_notebook
---

### Initialize cisTopic Object

In this project, we make use of the software **cisTopic** (Bravo Gonz√°lez-Blas et al., 2019), a framework employing the latent Dirichlet allocation (LDA) (Blei et al., 2003), that allows us to co-cluster DNA regulatory regions and cell types. 

We load the ATAC-seq data that was generated using SNARE-seq. (Bakken et al., 2021)
```{r}
ATACseq_dat = readRDS('ATACseq_data/Zhang_BICCN-H_20190523-20190611_huMOp_Final_AC_Peaks.RDS')

#Subset if needed
#subset = ATACseq_data[1:2000,1:2000]

```

In order to run cisTopic, we must convert our input peak matrix into a **cisTopic object**. Afterwards, we are able to train different models with a given number of topics using **LDA** - Laten Dirichlet Allocation (Blei et al., 2003).
```{r}

#Transform matrix into cisTopic object
cisTopicObject <- createcisTopicObject(subset, project.name='ATACseq_clustering')

#Read metadata from txt file 
metadata <- read.delim('ATAC-seq_data/Zhang_BICCN-H_20190523-20190611_huMOp_Final_Sample_Metadata.txt')

#Subset if needed
metadata = metadata [1:2000, ]

#Add metadata to cisTopic Object
cisTopicObject <- addCellMetadata(cisTopicObject, cell.data = metadata)

cisTopicObject <- runWarpLDAModels(cisTopicObject, topic=c(2:15, 20, 25, 35, 40, 45, 50), seed=123, nCores=1, addModels=FALSE)
```
We use the in-built function to select the best model. There are three available methods:
1.The log likelihood that estimates the plausibility of a model parameter value given the observed data (i.e. the highest the likelihood, the better the model). This is not recommended when building the models using LDA. 

2. The second derivative in each point of the likelihood curve (i.e. the highest the second derivative means that the next model is not improving much more the log-likelihood) . This is not recommended when running CGS. 

3. The perplexity of each model (only for WarpLDA models) measures how well the model predicts the sample. The lower the perplexity is, the better the model.

The modified function outputs corresponding plots for each of the three methods, as well as saves the best model in the cisTopic object.
```{r}
cisTopicObject <- selectModelModified(cisTopicObject, type='derivative')
```

### Cell states analysis

We can now use the resulting clustering to visualise the data, through a Umap and heatmap. 


*will add interpretation
```{r}
cisTopicObject <- runUmap(cisTopicObject, target='cell')

pdf('Umap.pdf')
plotFeatures(cisTopicObject, method='Umap', target='cell', topic_contr=NULL, colorBy=c('subclass', 'level1'))
dev.off ()

pdf('heatmap.pdf')
cellTopicHeatmap(cisTopicObject, method='Probability', colorBy=c('subclass'))
dev.off()
```

### Regulatory regions analysis
The first step in this analysis is deriving a score that evaluates the likelihood of a region belonging to a certain topic. The software does this automatically using the getRegionScores function. 
```{r}
cisTopicObject <- getRegionsScores(cisTopicObject, method='NormTop', scale=TRUE)

```


