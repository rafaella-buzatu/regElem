---
title: "Clustering using cisTopic"
output: html_notebook
---

### Initialization cisTopic Object

In this project, we make use of the software **cisTopic** (Bravo Gonz√°lez-Blas et al., 2019), a framework employing the latent Dirichlet allocation (LDA) (Blei et al., 2003), that allows us to co-cluster DNA regulatory regions and cell types. 
```{r}
#Load packages
library (cisTopic)
source('utils/altered_functions.R')
```

```{r}
#Define path to store plots
pathToPlotsDir = 'plots'
if (!dir.exists(file.path (pathToPlotsDir))){
  dir.create(file.path (pathToPlotsDir))
}

#Define path to store outputs
pathToOutputsDir = 'outputs'
if (!dir.exists(file.path (pathToOutputsDir))){
  dir.create(file.path (pathToOutputsDir))
}
```
We load the ATAC-seq data that was generated using SNARE-seq. (Bakken et al., 2021)
```{r}
ATACseqData = readRDS('ATACseq_data/Zhang_BICCN-H_20190523-20190611_huMOp_Final_AC_Peaks.RDS')
```

In order to run cisTopic, we must convert our input peak matrix into a **cisTopic object**. We can then add extra information to this object from the given metadata file. 
```{r}
#Transform matrix into cisTopic object
cisTopicObject <- createcisTopicObject(ATACseq_data, project.name='ATACseq_clustering')

#Read metadata from txt file 
metadataOrig <- read.delim('ATAC-seq_data/Zhang_BICCN-H_20190523-20190611_huMOp_Final_Sample_Metadata.txt')

#Give metadata dataframe and cisTopicObject matrix the same row names
metadata <- data.frame(metadataOrig, row.names = 1)
#Add metadata to cisTopic Object
cisTopicObject <- addCellMetadata(cisTopicObject, cell.data = metadata)
```
Afterwards, we are able to train different models with a given number of topics using **LDA** - Laten Dirichlet Allocation (Blei et al., 2003).
```{r}
#Run models
cisTopicObject <- runWarpLDAModels(cisTopicObject, topic=c(2:15, 20, 25, 35, 40, 45, 50), seed=123, nCores=1, addModels=FALSE)
```
We use the in-built function to select the best model. There are three available methods:
1.The log likelihood that estimates the plausibility of a model parameter value given the observed data (i.e. the highest the likelihood, the better the model). This is not recommended when building the models using LDA. 

2. The second derivative in each point of the likelihood curve (i.e. the highest the second derivative means that the next model is not improving much more the log-likelihood) . This is not recommended when running CGS. 

3. The perplexity of each model (only for WarpLDA models) measures how well the model predicts the sample. The lower the perplexity is, the better the model.

The modified function outputs corresponding plots for each of the three methods, as well as saves the best model in the cisTopic object.
```{r}
cisTopicObject <- selectModelModified(cisTopicObject, pathFolder = pathToPlotsDir, type='derivative')
```

### Cell states analysis

We can now use the resulting clustering to visualise the data. We can run tSNE and UMAP dimension reduction methods on the probability distributions of topics belonging to cells, and compare the results.
```{r}
#Run Umap
cisTopicObject <- runUmap(cisTopicObject, target='cell')
#Run tSNE
cisTopicObject <- runtSNE(cisTopicObject, target='cell')

#Extract Umap and tSNE scores for plotting
dimReductionCoords = cisTopicObject@dr$cell
#Read from Rds
#dimReductionCoords = readRDS(file.path(pathToOutputsDir,'dimReductionCoords.Rds'))

#Extract scores for topic assignment per cell
cellTopicAssignments <- cisTopicObject@selected.model$document_expects 
#read from Rds
#cellTopicAssignments <- readRDS(file.path(pathToOutputsDir,'cellTopicAssignments.Rds'))
#Convert to dataframe with all info
cellData <- createCellTopicDataFrame (cellTopicAssignments, dimReductionCoords, metadataOrig)

#Save dataframe
write_xlsx (cellData, file.path(pathToOutputsDir,'cellData.xlsx'))

#Create plots
createUMAPsPerTopic(cellData, pathToPlotsDir)
createtSNEsPerTopic(cellData, pathToPlotsDir)
```

### Regulatory regions analysis
The first step in this analysis is deriving a score that evaluates the likelihood of a region belonging to a certain topic based on the proportion of region specific assignments to that topic. The software does this automatically using the getRegionScores function. 
```{r}
cisTopicObject <- getRegionsScores(cisTopicObject, method='NormTop', scale=TRUE)
```
Following this, we can extract the probability scores of each region belonging to a topic, as well as binarize these scores using the in-built function. (*should read further on this*)
```{r}
#Extract dataframe with scores for all regions for all topics
regionScoresAllTopics = cisTopicObject@region.data

#Binarize topics; get most representative regions per topic
cisTopicObject <- binarizecisTopicsModified(cisTopicObject, pathFolder = pathToPlotsDir, thrP=0.975)

#Get regions for each topic and corresponding scores
regionScoresPerTopic = cisTopicObject@binarized.cisTopics

#Combine information in final dataframe
regionDataTopics <- createRegionDataFrame (regionScoresAllTopics, regionScoresPerTopic )
#Add DNA sequences for each region
regionData <- addDNAsequences (regionDataTopics)

#Save dataframe
write_xlsx (regionData, file.path(pathToOutputsDir,'regionData.xlsx'))
```

Save the cisTopic object.
```{r}
#Save the cisTopicObject
saveRDS(cisTopicObject, file= file.path(pathToOutputsDir,'cisTopicObject.Rds'))
```

